<html>

<head>
  <title>JamSoy - GameBoy Emulator</title>
  <link rel="stylesheet" href="reset.css" />
  <style>
    body {
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-evenly;
      height: 100vh;
      margin: 0;
      background-color: aliceblue;
    }

    canvas {
      image-rendering: pixelated;
      width: 320px;
      height: 288px;
    }

    @media (prefers-color-scheme: dark) {
      html {
        filter: invert(1) hue-rotate(180deg);
      }
    }
  </style>
</head>

<body>
  <h1>JamSoy - GameBoy Emulator</h1>
  <h2 id="title">&nbsp;</h2>

  <div>
    <canvas id="screen" width="160" height="144"></canvas>
  </div>

  <div>
    <input type="file" id="rom" accept=".gb" />
  </div>

  <script type="module">
    // @ts-check
    import { getMetadata, formatMetadata } from '../lib/cartridge.mjs';
    import { GameBoy } from './gameboy.mjs';
    import { Memory } from '../lib/memory.mjs';
    import { Interrupts } from '../lib/interrupts.mjs';
    import { CanvasScreen } from '../lib/screen.mjs';
    import { Graphics, CYCLES_TO_DRAW_LINE, LCD_CONTROL_REGISTER } from '../lib/graphics.mjs';

    const $rom = document.getElementById('rom');
    const $title = document.getElementById('title');
    const $screen = document.getElementById('screen');
    const canvasScreen = new CanvasScreen($screen);

    const gameboy = new GameBoy(canvasScreen);

    let animationFrameId;
    let lastTime = 0;
    const fps = 60;
    const frameDuration = 1000 / fps;

    const loop = (timestamp) => {
      if (timestamp - lastTime >= frameDuration) {
        lastTime = timestamp;
        gameboy.update();
      }
      animationFrameId = requestAnimationFrame(loop);
    };

    let reset;
    $rom.addEventListener('change', async (event) => {
      reset?.();
      canvasScreen.clear();
      const file = event.target.files[0];
      const buffer = await file.arrayBuffer();
      const rom = new Uint8Array(buffer);
      const metadata = getMetadata(rom);
      console.log(formatMetadata(metadata));

      $title.textContent = metadata.title;

      gameboy.loadROM(rom);
      lastTime = performance.now();
      animationFrameId = requestAnimationFrame(loop);
      reset = () => cancelAnimationFrame(animationFrameId);
    });
  </script>
</body>

</html>