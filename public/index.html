<html>

<head>
  <title>JamSoy - GameBoy Emulator</title>
  <link rel="stylesheet" href="reset.css" />
  <style>
    body {
      font-family: monospace;
      background-color: aliceblue;
    }

    section {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 1rem;
      padding: 1rem;
    }

    aside>div {
      padding: 1rem;
    }

    aside>div>label {
      padding: 1rem;
    }

    h1 {
      padding: 1rem;
    }

    canvas {
      image-rendering: pixelated;
      width: 320px;
      height: 288px;
    }

    @media (prefers-color-scheme: dark) {
      html {
        filter: invert(1) hue-rotate(180deg);
      }
    }
  </style>
</head>

<body>
  <h1>JamSoy - Tester</h1>
  <section>
    <main>
      <div>
        <canvas id="screen" width="160" height="144"></canvas>
      </div>
    </main>
    <aside>
      <h3>Tests</h3>
      <div>
        <h4>Blaggr's</h4>
        <select id="blaggr" onchange="loadROM(event.target.value)">
          <option>Select one</option>
          <optgroup label=" cpu_instrs">
            <option value="/fixtures/blaggr/cpu_instrs/individual/01-special.gb">01-special.gb</option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/02-interrupts.gb">02-interrupts.gb</option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/03-op sp,hl.gb">03-op sp,hl.gb</option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/04-op r,imm.gb">04-op r,imm.gb</option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/05-op rp.gb">05-op rp.gb</option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/06-ld r,r.gb">06-ld r,r.gb</option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/07-jr,jp,call,ret,rst.gb">07-jr,jp,call,ret,rst.gb
            </option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/08-misc instrs.gb">08-misc instrs.gb</option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/09-op r,r.gb">09-op r,r.gb</option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/10-bit ops.gb">10-bit ops.gb</option>
            <option value="/fixtures/blaggr/cpu_instrs/individual/11-op a,(hl).gb">11-op a,(hl).gb</option>
          </optgroup>
          <optgroup label="instr_timing">
            <option value="/fixtures/blaggr/instr_timing/instr_timing.gb">instr_timing.gb</option>
          </optgroup>
          <optgroup label="mem_timing">
            <option value="/fixtures/blaggr/mem_timing/individual/01-read_timing.gb">01-read_timing.gb</option>
            <option value="/fixtures/blaggr/mem_timing/individual/02-write_timing.gb">02-write_timing.gb</option>
            <option value="/fixtures/blaggr/mem_timing/individual/03-modify_timing.gb">03-modify_timing.gb</option>
          </optgroup>
          <optgroup label="mem_timing-2">
            <option value="/fixtures/blaggr/mem_timing-2/rom_singles/01-read_timing.gb">01-read_timing.gb</option>
            <option value="/fixtures/blaggr/mem_timing-2/rom_singles/02-write_timing.gb">02-write_timing.gb</option>
            <option value="/fixtures/blaggr/mem_timing-2/rom_singles/03-modify_timing.gb">03-modify_timing.gb</option>
          </optgroup>
          <optgroup label="halt_bug">
            <option value="/fixtures/blaggr/halt_bug.gb">halt_bug.gb</option>
          </optgroup>
          <optgroup label="oam_bug">
            <option value="/fixtures/blaggr/oam_bug/rom_singles/1-lcd_sync.gb">1-lcd_sync.gb</option>
            <option value="/fixtures/blaggr/oam_bug/rom_singles/2-causes.gb">2-causes.gb</option>
            <option value="/fixtures/blaggr/oam_bug/rom_singles/3-non_causes.gb">3-non_causes.gb</option>
            <option value="/fixtures/blaggr/oam_bug/rom_singles/4-scanline_timing.gb">4-scanline_timing.gb</option>
            <option value="/fixtures/blaggr/oam_bug/rom_singles/5-timing_bug.gb">5-timing_bug.gb</option>
            <option value="/fixtures/blaggr/oam_bug/rom_singles/6-timing_no_bug.gb">6-timing_no_bug.gb</option>
            <option value="/fixtures/blaggr/oam_bug/rom_singles/7-timing_effect.gb">7-timing_effect.gb</option>
            <option value="/fixtures/blaggr/oam_bug/rom_singles/8-instr_effect.gb">8-instr_effect.gb</option>
          </optgroup>
        </select>
      </div>

      <div>
        <h4>Games</h4>
        <select id="games" onchange="loadROM(event.target.value)">
          <option>Select one</option>
          <option value="/fixtures/games/snake.gb">Snake</option>
          <option value="/fixtures/games/Tetris.gb">Tetris</option>
          <option value="/fixtures/games/DrMario.gb">Dr. Mario</option>
          <option value="/fixtures/games/tictactoe.gb">TicTacToe</option>
        </select>
      </div>
    </aside>
  </section>

  <template id="test-card">
    <button></button>

    <script>
      const template = document.currentScript.parentElement;
      const button = template.content.querySelector('button');
      button.addEventListener('click', async () => {
        const rom = await fetch(button.value).then(response => response.blob());
        launch(rom);
      });
    </script>
  </template>

  <script type="module">
    // @ts-check
    import { getMetadata, formatMetadata } from '../lib/cartridge.mjs';
    import { GameBoy } from './gameboy.mjs';
    import { Memory } from '../lib/memory.mjs';
    import { Interrupts } from '../lib/interrupts.mjs';
    import { CanvasScreen } from '../lib/screen.mjs';
    import { Graphics, CYCLES_TO_DRAW_LINE, LCD_CONTROL_REGISTER } from '../lib/graphics.mjs';

    const $rom = document.getElementById('rom');
    const $screen = document.getElementById('screen');
    const canvasScreen = new CanvasScreen($screen);
    const gameboy = new GameBoy(canvasScreen);

    let reset;
    const launch = async (file) => {
      reset?.();
      canvasScreen.clear();
      const buffer = await file.arrayBuffer();
      const rom = new Uint8Array(buffer);
      const metadata = getMetadata(rom);
      console.log(formatMetadata(metadata));

      gameboy.loadROM(rom);
      const timerID = setInterval(gameboy.update.bind(gameboy), 15);
      reset = () => clearInterval(timerID);
    }

    window.gameboy = gameboy;
    window.screen = canvasScreen;
    window.loadROM = (url) => fetch(url)
      .then(response => response.blob())
      .then(launch);
  </script>
</body>

</html>