<html>

<head>
  <title>JamSoy - GameBoy Emulator</title>
  <style>
    canvas {
      image-rendering: pixelated;
      width: 320px;
      height: 288px;
    }
  </style>
</head>

<body>
  <h1>JamSoy - GameBoy Emulator</h1>
  <h2 id="title"></h2>

  <div>
    <canvas id="screen" width="160" height="144"></canvas>
  </div>

  <div>
    <h3>Load ROM</h3>
    <input type="file" id="rom" accept=".gb" />
    <button id="test">Test</button>
  </div>

  <script type="module">
    // @ts-check
    import { getMetadata } from '../lib/cartridge.mjs';
    import { GameBoy } from './gameboy.mjs';
    import { Memory } from '../lib/memory.mjs';
    import { Interrupts } from '../lib/interrupts.mjs';
    import { CanvasScreen } from '../lib/screen.mjs';
    import { Graphics, CYCLES_TO_DRAW_LINE, LCD_CONTROL_REGISTER } from '../lib/graphics.mjs';

    const $rom = document.getElementById('rom');
    const $title = document.getElementById('title');
    const $screen = document.getElementById('screen');
    const $test = document.getElementById('test');

    $test?.addEventListener('click', async () => {
      const memory = new Memory();
      const interrupts = new Interrupts(memory, {});
      const screen = new CanvasScreen($screen);
      const graphics = new Graphics(memory, interrupts, screen);

      // Set up the LCD control byte to enable the LCD
      memory.unsafeWriteByte(LCD_CONTROL_REGISTER, 0b10110001); // Example value to enable LCD and background

      const tileData = [
        0xFF, 0xFF,
        0x81, 0x81,
        0xBD, 0xBD,
        0xA5, 0xA5,
        0xA5, 0xA5,
        0xBD, 0xBD,
        0x81, 0x81,
        0xFF, 0xFF
      ];

      const tileAddress = 0x8000;
      for (let i = 0; i < tileData.length; i++) {
        memory.unsafeWriteByte(tileAddress + i, tileData[i]);
      }

      // Set up the background map to use the tile at address 0x8000
      const backgroundMapAddress = 0x9800;
      for (let i = 0; i < 32 * 32; i++) { // 32x32 tiles
        memory.unsafeWriteByte(backgroundMapAddress + i, 0x00); // Tile index 0
      }

      // Update the graphics to render the sprite
      for (let i = 0; i < CYCLES_TO_DRAW_LINE; i++) {
        graphics.update(i);
      }
      screen.draw();
    });


    const gameboy = new GameBoy($screen);

    const loop = () => {
      requestAnimationFrame(() => {
        gameboy.update();
        loop();
      })
    }

    $rom.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      const buffer = await file.arrayBuffer();
      const rom = new Uint8Array(buffer);
      const metadata = getMetadata(rom);

      $title.textContent = metadata.title;

      gameboy.loadROM(rom);
      loop()
    });
  </script>
</body>

</html>