<html>

<head>
  <title>JamSoy - GameBoy Emulator</title>
  <link rel="stylesheet" href="reset.css" />
  <style>
    body {
      font-family: monospace;
      background-color: aliceblue;
    }

    section {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 1rem;
      padding: 1rem;
    }

    aside>div {
      padding: 1rem;
    }

    aside>div>label {
      padding: 1rem;
    }

    h1 {
      padding: 1rem;
    }

    canvas {
      image-rendering: pixelated;
      width: 320px;
      height: 288px;
    }

    html.dark {
      filter: invert(1) hue-rotate(180deg);
    }
  </style>
</head>

<body>
  <h1>JamSoy - Gameboy Emulator</h1>
  <section>
    <main>
      <div>
        <canvas id="screen" width="160" height="144"></canvas>
      </div>
    </main>
    <aside>
      <h3>Colors</h3>
      <div>
        <label>
          <input type="checkbox" id="dark-mode"
            onchange="document.getElementsByTagName('html')[0].classList.toggle('dark')" />
          Dark mode
        </label>
      </div>
      <h3>ROM</h3>
      <div>
        <input type="file" id="rom" />
      </div>
      <h3>Metadata</h3>
      <div>
        <pre id="metadata"></pre>
      </div>
    </aside>
  </section>

  <script type="module">
    // @ts-check
    import { getMetadata, formatMetadata } from './lib/cartridge.mjs';
    import { GameBoy } from './lib/gameboy.mjs';
    import { CanvasScreen } from './lib/gfx/screen.mjs';
    import { Input, KEY } from './lib/input.mjs';

    const $rom = document.getElementById('rom');
    const $screen = document.getElementById('screen');
    const $metadata = document.getElementById('metadata');

    const canvasScreen = new CanvasScreen($screen);
    const input = new Input();
    const gameboy = new GameBoy(canvasScreen, input);

    const keyMap = {
      ArrowUp: KEY.UP,
      ArrowDown: KEY.DOWN,
      ArrowLeft: KEY.LEFT,
      ArrowRight: KEY.RIGHT,
      z: KEY.A,
      x: KEY.B,
      Enter: KEY.START,
      Shift: KEY.SELECT,
    };

    const loop = () => {
      gameboy.update();
      canvasScreen.draw();
      return requestAnimationFrame(loop);
    }

    const launch = async (file) => {
      canvasScreen.clear();
      const buffer = await file.arrayBuffer();
      const rom = new Uint8Array(buffer);
      const metadata = getMetadata(rom);
      $metadata.textContent = formatMetadata(metadata);
      gameboy.loadROM(rom);
      loop();
    }

    window.onload = () => {
      const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
      if (prefersDarkScheme) {
        document.getElementById('dark-mode').checked = true;
        document.getElementsByTagName('html')[0].classList.add('dark');
      }
    }

    window.addEventListener('keydown', (event) => {
      input.keyDown(keyMap[event.key])
    });
    window.addEventListener('keyup', (event) => input.keyUp(keyMap[event.key]));

    $rom.addEventListener('change', (event) => {
      const file = event.target.files[0];
      launch(file);
    });
  </script>
</body>

</html>